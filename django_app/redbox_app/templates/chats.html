{% set pageTitle = "Chats" %}
{% extends "base.html" %}
{% from "macros/govuk-button.html" import govukButton %}
{% from "macros/govuk-notification-banner.html" import govukNotificationBanner %}

{% block content %}

<div class="govuk-width-container">

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-third">
      <h1 class="govuk-heading-l">Chats</h1>
    </div>
  </div>

  <div class="govuk-grid-row">

    <div class="govuk-grid-column-one-third">

    {{ govukButton(
      text="Start a new chat",
      href=url('chats'),
      classes="govuk-button--secondary"
    ) }}

    <h2 class="govuk-heading-s">Recent chats</h2>
    <ul class="govuk-list govuk-list--spaced">
      {% for chat in chat_history %}
        <li>
          <a class="govuk-link" href="{{url('chats', chat.id)}}">{{ chat.name }}</a>
        </li>
      {% endfor %}
    </ul>

  </div>

  <div class="govuk-grid-column-two-thirds">
    <chat-controller data-stream-url="{{ streaming.endpoint }}" data-session-id="{{ chat_id or '' }}">

      <h2 class="govuk-heading-m">Current chat</h2>

      {{ govukNotificationBanner(
        title="Important",
        text_list=[
          {"text": "Responses are generated by Artificial Intelligence (AI)"},
          {"text": "You must check the response for accuracy", "bold": True}
        ],
        heading_level="3"
      ) }}

      {% macro message_box(role, text, sources, classes=None) %}

        <div class="iai-chat-message iai-chat-message--{{ role }} js-chat-message govuk-body {{ classes }}" data-role="{{ role }}" tabindex="-1">
          <div class="iai-chat-message__role">{% if role == 'ai' %}Redbox{% else %}You{% endif %}</div>
          <markdown-converter class="iai-chat-message__text">{{ text }}</markdown-converter>
          {% if sources %}
            <h3 class="iai-chat-message__sources-heading govuk-heading-s govuk-!-margin-bottom-1">Sources</h3>
            <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-0">
              {% for source in sources %}
                <li class="govuk-!-margin-bottom-0">
                  <a class="iai-chat-messages__sources-link govuk-link" href="{{ source.url }}">{{ source.original_file_name }}</a>
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      {% endmacro %}

      <div class="iai-chat-message__container js-message-container">

        {# SSR messages #}
        {% for message in messages %}
          {{ message_box(
            role = message.role,
            text = message.text,
            sources = message.source_files.all()
          ) }}
        {% endfor %}

        {# CSR messages are inserted here #}

        <div class="iai-response-feedback js-response-feedback">
          <feedback-buttons class="iai-response-feedback__buttons"></feedback-buttons>
          {{ message_box(
            role = "AI",
            text = "Thank you for your feedback",
            classes = "iai-response-feedback__thumbs-up"
          ) }}
          {{ message_box(
            role = "AI",
            text = "Ok. Can you let me know what wasnâ€™t accurate? I can refine it again to make it more accurate.",
            classes = "iai-response-feedback__thumbs-down"
          ) }}
        </div>

      </div>

      <form class="iai-new-message js-send-message" action="/post-message/" method="post">

        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"/>
        {% if chat_id %}<input type="hidden" name="session-id" value="{{ chat_id }}"/>{% endif %}

        <div class="govuk-form-group">
          <label class="govuk-label" for="message">
            Write a message
          </label>
          <textarea class="govuk-textarea js-user-text" id="message" name="message" rows="5" required></textarea>
        </div>

          <button type="submit" class="govuk-button js-send-btn" {% if not streaming.in_use %}data-prevent-double-click="true"{% endif %} data-module="govuk-button">
            Send
          </button>
    
        </form>

        <div class="iai-response-loading js-response-loading govuk-!-margin-top-1" tabindex="-1">
          <img class="iai-response-loading__spinner" src="{{ static('images/spinner.gif') }}" alt=""/>
          <p class="iai-response-loading__text govuk-body govuk-!-margin-bottom-0 govuk-!-margin-left-1">Response loading...</p>
        </div>
    
      </chat-controller>
    </div>
  
  </div>
</div>

<script src="{{ static('js/libs/dompurify.js') }}"></script>
<script src="{{ static('js/libs/showdown.min.js') }}"></script>
{% if COMPRESSION_ENABLED %}
  {% compress js %}
    <script src="{{ static('js/chats/markdown.js') }}"></script>
    <script src="{{ static('js/chats/feedback.js') }}"></script>
  {% endcompress %}
{% else %}
  <script src="{{ static('js/chats/markdown.js') }}"></script>
  <script src="{{ static('js/chats/feedback.js') }}"></script>
{% endif %}


{% if streaming.in_use %}
  {% if COMPRESSION_ENABLED %}
    {% compress js %}
      <script src="{{ static('js/chats/streaming.js') }}"></script>
    {% endcompress %}
  {% else %}
    <script src="{{ static('js/chats/streaming.js') }}"></script>
  {% endif %}
{% else %}
  <script src="{{ static('js/chats/fallback.js') }}"></script>
{% endif %}

{% endblock %}
