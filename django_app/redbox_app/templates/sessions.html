{% set pageTitle = "Chat" %}
{% extends "base.html" %}
{% from "macros/govuk-button.html" import govukButton %}
{% from "macros/govuk-notification-banner.html" import govukNotificationBanner %}

{% block content %}

<div class="govuk-width-container">

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-third">
      <h1 class="govuk-heading-l">Sessions</h1>
    </div>
  </div>

  <div class="govuk-grid-row">

    <div class="govuk-grid-column-one-third">

    {{ govukButton(
      text="Start a new session",
      href=url('sessions'),
      classes="govuk-button--secondary"
    ) }}

    <h2 class="govuk-heading-s">Recent sessions</h2>
    <ul class="govuk-list govuk-list--spaced">
      {% for session in chat_history %}
        <li>
          <a class="govuk-link" href="{{url('sessions', session.id)}}">{{ session.name }}</a>
        </li>
      {% endfor %}
    </ul>

  </div>

  <chat-controller data-stream-url="{{ streaming.endpoint }}" data-session-id="{{ session_id or '' }}" class="govuk-grid-column-two-thirds">

    <h2 class="govuk-heading-m">Current session</h2>

    {{ govukNotificationBanner(
      title="Important",
      text_list=[
        {"text": "Responses are generated by Artificial Intelligence (AI)"},
        {"text": "You must check the response for accuracy", "bold": True}
      ],
      heading_level="3"
    ) }}

    {% macro message_box(role, text, sources, classes=None) %}

      <div class="iai-chat-message iai-chat-message--{{ role }} govuk-body {{ classes }}" data-role="{{ role }}">
        <div class="iai-chat-message__role">{{ role | upper }}</div>
        <markdown-converter class="iai-chat-message__text">{{ text }}</markdown-converter>
        {% if sources %}
          <h3 class="iai-chat-message__sources-heading govuk-heading-s govuk-!-margin-bottom-1">Sources</h3>
          <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-0">
            {% for source in sources %}
              <li class="govuk-!-margin-bottom-0">
                <a class="iai-chat-messages__sources-link govuk-link" href="{{ source.url }}">{{ source.original_file_name }}</a>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    {% endmacro %}

    <div class="iai-chat-message__container js-message-container">

      {# SSR messages #}
      {% for message in messages %}
        {{ message_box(
          role = message.role,
          text = message.text,
          sources = message.source_files.all()
        ) }}
      {% endfor %}

      {# CSR messages are inserted here #}

      <div class="iai-response-feedback js-response-feedback">
        <feedback-buttons class="iai-response-feedback__buttons"></feedback-buttons>
        {{ message_box(
          role = "AI",
          text = "Thank you for your feedback",
          classes = "iai-chat-message--feedback-thumbs-up"
        ) }}
        {{ message_box(
          role = "AI",
          text = "Ok. Can you let me know what wasnâ€™t accurate? I can refine it again to make it more accurate.",
          classes = "iai-chat-message--feedback-thumbs-down"
        ) }}
      </div>

    </div>

    <form class="iai-new-message js-send-message" action="/post-message/" method="post">

      <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"/>
      {% if session_id %}<input type="hidden" name="session-id" value="{{ session_id }}"/>{% endif %}

      <div class="govuk-form-group">
        <label class="govuk-label" for="message">
          Write a message
        </label>
        <textarea class="govuk-textarea js-user-text" id="message" name="message" rows="5" required></textarea>
      </div>

        <button type="submit" class="govuk-button js-send-btn" data-module="govuk-button">
          Send
        </button>
  
      </form>
  
    </chat-controller>
  
  </div>
</div>

<script src="{{ static('js/libs/dompurify.js') }}"></script>
<script src="{{ static('js/libs/showdown.min.js') }}"></script>
{% if COMPRESSION_ENABLED %}
  {% compress js %}
    <script src="{{ static('js/sessions/markdown.js') }}"></script>
    <script src="{{ static('js/sessions/feedback.js') }}"></script>
  {% endcompress %}
{% else %}
  <script src="{{ static('js/sessions/markdown.js') }}"></script>
  <script src="{{ static('js/sessions/feedback.js') }}"></script>
{% endif %}


{% if streaming.in_use %}
  {% if COMPRESSION_ENABLED %}
    {% compress js %}
      <script src="{{ static('js/sessions/streaming.js') }}"></script>
    {% endcompress %}
  {% else %}
    <script src="{{ static('js/sessions/streaming.js') }}"></script>
  {% endif %}
{% endif %}

{% endblock %}
