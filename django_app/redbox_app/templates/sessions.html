{% set pageTitle = "Chat" %}
{% extends "base.html" %}
{% from "macros/govuk-button.html" import govukButton %}

{% block content %}

<div class="govuk-width-container">
  <div class="govuk-grid-row govuk-!-margin-top-3">

  <div class="govuk-grid-column-one-third">

    {{ govukButton(
      text="Start a new session",
      href="/sessions",
      classes="govuk-button--secondary"
    ) }}

    <h2 class="govuk-heading-s">Recent sessions</h2>
    <ul class="govuk-list govuk-list--spaced">
      {% for session in chat_history %}
        <li>
          <a class="govuk-link" href="/sessions/{{ session.id }}">{{ session.name }}</a>
        </li>
      {% endfor %}
    </ul>
      
  </div>

  <chat-controller data-stream-url="{{ streaming.endpoint }}" data-session-id="{{ session_id }}" class="govuk-grid-column-two-thirds">

    <h2 class="govuk-heading-m">Current session</h2>

    <div class="govuk-notification-banner" role="region" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
      <div class="govuk-notification-banner__header">
        <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
          Important
        </h2>
      </div>
      <div class="govuk-notification-banner__content">
        <p class="govuk-!-margin-bottom-1 govuk-!-margin-top-0">Responses are generated by Artificial Intelligence (AI)</p>
        <p class="govuk-notification-banner__heading">
          You must check the response for accuracy
        </p>
      </div>
    </div>

    {% macro message_box(role, text, classes=None) %}
      <div class="iai-chat-message iai-chat-message--{{ role }} govuk-body {{ classes }}" data-role="{{ role }}">
        <div class="iai-chat-message__role">{{ role | upper }}</div>
        <markdown-converter class="iai-chat-message__text">{{ text }}</markdown-converter>
      </div>
    {% endmacro %}

    <div class="js-message-container">

      {# SSR messages #}
      {% for message in messages %}
        {{ message_box(
          role = message.role,
          text = message.text
        ) }}
      {% endfor %}

      {# CSR messages are inserted here #}

      <div class="iai-response-feedback js-response-feedback">
        <feedback-buttons class="iai-response-feedback__buttons"></feedback-buttons>
        {{ message_box(
          role = "AI",
          text = "Thank you for your feedback",
          classes = "iai-chat-message--feedback-thumbs-up"
        ) }}
        {{ message_box(
          role = "AI",
          text = "Ok. Can you let me know what wasnâ€™t accurate? I can refine it again to make it more accurate.",
          classes = "iai-chat-message--feedback-thumbs-down"
        ) }}
      </div>

    </div>

    <form class="iai-new-message js-send-message" action="/post-message/" method="post">

      <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"/>
      <input type="hidden" name="session-id" value="{{ session_id }}"/>

      <div class="govuk-form-group">
        <label class="govuk-label" for="message">
          Write a message
        </label>
        <textarea class="govuk-textarea js-user-text" id="message" name="message" rows="5" required></textarea>
      </div>

      <button type="submit" class="govuk-button js-send-btn" data-module="govuk-button">
        Send
      </button>

    </form>

  </chat-controller>

</div>

</div>

<script src="{{ static('js/libs/dompurify.js') }}"></script>
<script src="{{ static('js/libs/showdown.min.js') }}"></script>
{% if COMPRESSION_ENABLED %}
  {% compress js %}
    <script src="{{ static('js/sessions/markdown.js') }}"></script>
    <script src="{{ static('js/sessions/feedback.js') }}"></script>
  {% endcompress %}
{% else %}
  <script src="{{ static('js/sessions/markdown.js') }}"></script>
  <script src="{{ static('js/sessions/feedback.js') }}"></script>
{% endif %}


{% if streaming.in_use %}
  {% if COMPRESSION_ENABLED %}
    {% compress js %}
      <script src="{{ static('js/sessions/streaming.js') }}"></script>
    {% endcompress %}
  {% else %}
    <script src="{{ static('js/sessions/streaming.js') }}"></script>
  {% endif %}
{% endif %}

{% endblock %}